# --- Cấu hình ---
$Url = 'https://github.com/3proxy/3proxy/releases/download/0.9.5/3proxy-0.9.5-lite.zip'
$DestDir = Join-Path $env:LocalAppData 'proxy'
$TempZip = Join-Path $env:TEMP '3proxy-0.9.5-lite.zip'

# --- Tạo thư mục đích nếu chưa có ---
if (-not (Test-Path -Path $DestDir)) {
    New-Item -Path $DestDir -ItemType Directory -Force | Out-Null
    Write-Host "[+] Tạo thư mục: $DestDir"
} else {
    Write-Host "[*] Thư mục đã tồn tại: $DestDir"
}

# --- Tải file ---
Write-Host "[*] Đang tải $Url -> $TempZip"
try {
    Invoke-WebRequest -Uri $Url -OutFile $TempZip -UseBasicParsing -Verbose
} catch {
    Write-Error "Lỗi khi tải file: $_"
    exit 1
}

# --- Giải nén (ghi đè) ---
Write-Host "[*] Giải nén vào $DestDir"
try {
    # Remove existing files if you want a clean extract (comment nếu không muốn xóa)
    # Remove-Item -Path (Join-Path $DestDir '*') -Recurse -Force -ErrorAction SilentlyContinue

    Expand-Archive -Path $TempZip -DestinationPath $DestDir -Force
} catch {
    Write-Error "Lỗi khi giải nén bằng Expand-Archive: $_"
    # Fallback: sử dụng .NET if Expand-Archive không có
    try {
        Add-Type -AssemblyName System.IO.Compression.FileSystem
        [System.IO.Compression.ZipFile]::ExtractToDirectory($TempZip, $DestDir, $true)
    } catch {
        Write-Error "Fallback giải nén thất bại: $_"
        exit 1
    }
}

# --- Dọn file tạm ---
Remove-Item -Path $TempZip -Force -ErrorAction SilentlyContinue

Write-Host "[+] Hoàn tất. Nội dung thư mục $DestDir:"
Get-ChildItem -Path $DestDir -Depth 1
